<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title>Map</title>
	<script src='//api.tiles.mapbox.com/mapbox.js/v1.4.2/mapbox.js'></script>
	<link href='//api.tiles.mapbox.com/mapbox.js/v1.4.2/mapbox.css' rel='stylesheet' />
	<script src="/js/leaflet.markercluster.js"></script>
	<link rel="stylesheet" href="/style/MarkerCluster.css"/>
	<link rel="stylesheet" href="/style/MarkerCluster.Default.css" />
	<link rel="stylesheet" type="text/css" href="/style/style.css">
	<style>
		body { margin:0; padding:0; }
		#map { position:absolute; top:0; bottom:0; width:100%; }
	</style>
</head>
<body>
	<style>
		#map { position:absolute; top:0; bottom:0; right:340px; left:0; }
		#info {
			position:absolute; top: 0; right: 0;
			bottom: 0; width: 300px; background:#333; color: #fff;
			padding:20px;
			overflow: auto;
		}
		h1 { margin-top:0; }
	</style>

	<div id='map'></div>
	<div id='info'></div>

	<script>
		var request = new XMLHttpRequest();
		request.open("GET", '{{ page.geojson }}', false);
		request.send(null);
		var geoJson = JSON.parse(request.responseText);
		
		var map = L.mapbox.map('map', 'examples.map-20v6611k').setView([53, 2], 6);

		var markers = new L.MarkerClusterGroup({showCoverageOnHover: false, zoomToBoundsOnClick: false,
			iconCreateFunction: function(cluster) {
				    return new L.DivIcon({ html: '<div style="background-image:url(http://img-fotki.yandex.ru/get/' + cluster.getAllChildMarkers()[0].options.properties.image_url + '_S.jpg)" class="smallphoto"></div>'});
			},
			singleMarkerMode: true
		});

		for (var i = 0; i < geoJson.features.length; i++) {
	        var a = geoJson.features[i];
	        var marker = L.marker(new L.LatLng(a.geometry.coordinates[1], a.geometry.coordinates[0]), {
	            icon: L.mapbox.marker.icon({'marker-symbol': 'post', 'marker-color': '0044FF'}),
	            properties: a.properties
	        });
	        markers.addLayer(marker);
	    }
	    map.addLayer(markers);

	    markers.on('click', function (e) {
			var feature = e.layer.options;
			document.getElementById('info').innerHTML = '<img class="bigphoto" src="http://img-fotki.yandex.ru/get/' + feature.properties.image_url+'_M.jpg"></img>';
		});

		markers.on('clusterclick', function (a) {
    		var children = a.layer.getAllChildMarkers();
    		var info = ""
			for (var i = 0; i < children.length; i++) {
		        var feature = children[i].options;
		        info = info + '<img class="bigphoto" src="http://img-fotki.yandex.ru/get/' + feature.properties.image_url+'_M.jpg"></img>';
		    }
		    document.getElementById('info').innerHTML = info;
		});

		map.on('click',function(e){ // Clear the tooltip when map is clicked
			document.getElementById('info').innerHTML = '';
		});
	</script>
</body>
</html>